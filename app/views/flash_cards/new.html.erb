<div class="page">
  <div class="headline">
    <h1>Flash Cards Builder</h1>
    <p>Upload a PDF, add guidance, and get Anki-ready cards from your local model.</p>
    <div class="actions">
      <%= link_to "View Jobs", "/jobs", class: "btn" %>
    </div>
  </div>

  <% if flash.now[:alert].present? %>
    <div class="alert"><%= flash.now[:alert] %></div>
  <% end %>

  <div class="card">
    <%= form_with url: flash_cards_path, method: :post, multipart: true, class: "form-grid" do |form| %>
      <div>
        <label for="pdf">PDF file</label>
        <%= form.file_field :pdf, required: true %>
      </div>

      <div>
        <label for="model">Ollama model</label>
        <% if @available_models.present? %>
          <%= form.select :model, options_for_select(@available_models, @default_model) %>
          <div class="hint">Detected <%= @available_models.size %> local models.</div>
        <% else %>
          <%= form.text_field :model, value: @default_model %>
          <div class="hint">No models detected. Enter a model name manually.</div>
        <% end %>
      </div>

      <div>
        <label for="embedding_model">Embedding model</label>
        <%= form.text_field :embedding_model, value: ENV.fetch("OLLAMA_EMBEDDING_MODEL", "nomic-embed-text"), list: "ollama-models", autocomplete: "off" %>
        <datalist id="ollama-models">
          <% Array(@available_models).each do |model_name| %>
            <option value="<%= model_name %>"></option>
          <% end %>
        </datalist>
        <div class="hint">
          Used for embedding/vector workflows. Typical choices: <code>nomic-embed-text</code>, <code>mxbai-embed-large</code>.
        </div>
      </div>

      <div>
        <label for="detail-slider">Detail level</label>
        <div class="detail-slider">
          <input id="detail-level-hidden" type="hidden" name="detail_level" value="medium" autocomplete="off">
          <input id="detail-slider" type="range" min="1" max="3" step="1" value="2" aria-label="Detail level slider" autocomplete="off">
          <div class="detail-slider__labels">
            <span>LOW</span>
            <span id="detail-label" class="detail-slider__current">MEDIUM</span>
            <span>HIGH</span>
          </div>
          <div class="hint">
            LOW = fewer cards, HIGH = as many as possible per section (within reasonable limits).
          </div>
        </div>
      </div>

      <div>
        <label for="notes">What does the PDF cover?</label>
        <%= form.text_area :notes, rows: 6, placeholder: "Summarize the content, key terms, or any must-cover topics." %>
      </div>

      <div>
        <label for="guidance">How should the cards be written?</label>
        <%= form.text_area :guidance, rows: 6, placeholder: "Example: focus on definitions, include key formulas, keep answers short." %>
      </div>

      <div>
        <label for="chunking_hint">Chunking hint (optional)</label>
        <%= form.text_area :chunking_hint, rows: 4, placeholder: "Optional: describe the doc structure (e.g., Rule / Section / Article)." %>
        <div class="hint">The first step will propose semantic sections for you to review before generating cards.</div>
      </div>

      <div>
        <%= form.submit "Generate Anki Cards", class: "btn" %>
      </div>
    <% end %>
  </div>

  <% if @recent_requests.any? %>
    <div class="recent">
      <h2>Recent requests</h2>
      <ul>
        <% @recent_requests.each do |request| %>
          <li>
            <strong>
              <%= link_to request.pdf_filename, flash_card_path(request), class: "link" %>
            </strong>
            <span>
              <%= request.model %> · <%= request.status %> · <%= request.created_at.strftime("%Y-%m-%d %H:%M") %>
            </span>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>
